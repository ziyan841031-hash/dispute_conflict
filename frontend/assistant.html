<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>矛盾纠纷系统管理 - 智能助手</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="vendor/reactflow.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h1>矛盾纠纷系统管理</h1>
    <a href="index.html">控台首页</a>
    <a href="cases.html">案件管理</a>
    <a class="active" href="assistant.html">智能助手</a>
  </aside>
  <main class="content">
    <section class="card assistant-header-card">
      <h2>智能助手</h2>
      <div id="assistantTopInfo" class="assistant-top-grid"></div>
    </section>

    <section class="assistant-main-grid">
      <div class="card flow-card">
        <h3>智能工作流</h3>
        <div class="flow-container">
          <div id="reactWorkflowRoot" class="workflow-canvas"></div>
        </div>
      </div>

      <div class="card side-card">
        <div class="bookmark-tabs">
          <button class="bookmark-tab active" data-tab="guide" onclick="switchAssistantTab('guide')">智能指引</button>
          <button class="bookmark-tab" data-tab="timeline" onclick="switchAssistantTab('timeline')">办理时间轴</button>
        </div>

        <div class="guide-panel" data-panel="guide">
          <h3>智能指引</h3>
          <div id="guideList" class="scroll-box"></div>
          <div class="guide-input-row">
            <input id="guideInput" placeholder="输入补充指引信息..." />
            <button onclick="addGuideNote()">添加</button>
          </div>
        </div>

        <div class="timeline-panel hidden" data-panel="timeline">
          <h3>办理时间轴</h3>
          <div id="timelineList" class="timeline-vertical"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/reactflow/dist/umd/index.js"></script>
<script>
  (function () {
    if (!window.React || !window.ReactDOM || !window.ReactFlow) {
      return;
    }

    const h = window.React.createElement;
    const useMemo = window.React.useMemo;
    const useState = window.React.useState;

    const RF = window.ReactFlow;
    const ReactFlowComp = RF.ReactFlow;
    const Background = RF.Background;
    const Controls = RF.Controls;
    const MarkerType = RF.MarkerType;

    function WorkflowNode(props) {
      const data = props.data || {};
      const selected = props.selected;
      return h('div', {
          className: `bg-white rounded-xl border shadow-sm hover:shadow-md px-3 py-2 min-w-[108px] text-center transition-all ${selected ? 'border-green-500 ring-2 ring-green-100' : 'border-zinc-200'}`
        },
        h('div', {className: 'text-sm font-semibold text-zinc-900'}, data.title || '-'),
        h('div', {className: 'text-xs text-zinc-500 mt-1'}, data.subtitle || '')
      );
    }

    const nodeTypes = {workflow: WorkflowNode};

    const baseNodes = [
      { id: 'accept', position: { x: 20, y: 240 }, data: { title: '已受理', subtitle: '--' }, type: 'workflow' },

      { id: 'mediation', position: { x: 240, y: 70 }, data: { title: '调解', subtitle: '二级节点' }, type: 'workflow' },
      { id: 'huajie', position: { x: 240, y: 190 }, data: { title: '化解', subtitle: '二级节点' }, type: 'workflow' },
      { id: 'huanjie', position: { x: 240, y: 310 }, data: { title: '缓解', subtitle: '二级节点' }, type: 'workflow' },
      { id: 'shujie', position: { x: 240, y: 430 }, data: { title: '疏解', subtitle: '二级节点' }, type: 'workflow' },

      { id: 'people', position: { x: 500, y: 140 }, data: { title: '人民调解', subtitle: '三级节点' }, type: 'workflow' },
      { id: 'admin', position: { x: 500, y: 260 }, data: { title: '行政调解', subtitle: '三级节点' }, type: 'workflow' },
      { id: 'professional', position: { x: 500, y: 380 }, data: { title: '专业调解', subtitle: '三级节点' }, type: 'workflow' },

      { id: 'status', position: { x: 760, y: 260 }, data: { title: '调解状态', subtitle: '四级节点' }, type: 'workflow' },
      { id: 'success', position: { x: 980, y: 180 }, data: { title: '调解成功', subtitle: '结果分支' }, type: 'workflow' },
      { id: 'failed', position: { x: 980, y: 340 }, data: { title: '调解失败', subtitle: '结果分支' }, type: 'workflow' },
      { id: 'archive', position: { x: 1180, y: 260 }, data: { title: '案件归档', subtitle: '五级节点' }, type: 'workflow' }
    ];

    const baseEdges = [
      { id: 'e-accept-mediation', source: 'accept', target: 'mediation', label: '分流' },
      { id: 'e-accept-huajie', source: 'accept', target: 'huajie', label: '分流' },
      { id: 'e-accept-huanjie', source: 'accept', target: 'huanjie', label: '分流' },
      { id: 'e-accept-shujie', source: 'accept', target: 'shujie', label: '分流' },

      { id: 'e-mediation-people', source: 'mediation', target: 'people' },
      { id: 'e-mediation-admin', source: 'mediation', target: 'admin' },
      { id: 'e-mediation-professional', source: 'mediation', target: 'professional' },

      { id: 'e-people-status', source: 'people', target: 'status' },
      { id: 'e-admin-status', source: 'admin', target: 'status' },
      { id: 'e-professional-status', source: 'professional', target: 'status' },

      { id: 'e-status-success', source: 'status', target: 'success' },
      { id: 'e-status-failed', source: 'status', target: 'failed' },
      { id: 'e-success-archive', source: 'success', target: 'archive' },
      { id: 'e-failed-archive', source: 'failed', target: 'archive' }
    ];

    function walkUpstream(targetId, parentMap, edgeSet, nodeSet) {
      nodeSet.add(targetId);
      if (targetId === 'accept') {
        return;
      }
      const incoming = parentMap[targetId] || [];
      incoming.forEach((edge) => {
        edgeSet.add(edge.id);
        walkUpstream(edge.source, parentMap, edgeSet, nodeSet);
      });
    }

    function WorkflowApp() {
      const [activeNodeId, setActiveNodeId] = useState('accept');
      const [acceptTime, setAcceptTime] = useState('--');

      window.updateWorkflowAcceptTime = function (timeText) {
        setAcceptTime(timeText || '--');
      };

      const parentMap = useMemo(() => {
        const m = {};
        baseEdges.forEach((edge) => {
          if (!m[edge.target]) {
            m[edge.target] = [];
          }
          m[edge.target].push(edge);
        });
        return m;
      }, []);

      const pathState = useMemo(() => {
        const edgeSet = new Set();
        const nodeSet = new Set();
        walkUpstream(activeNodeId, parentMap, edgeSet, nodeSet);
        return { edgeSet, nodeSet };
      }, [activeNodeId, parentMap]);

      const nodes = useMemo(() => {
        return baseNodes.map((node) => {
          const isAccept = node.id === 'accept';
          const isInPath = pathState.nodeSet.has(node.id);
          return {
            ...node,
            data: {
              ...node.data,
              subtitle: isAccept ? acceptTime : node.data.subtitle
            },
            selected: isInPath
          };
        });
      }, [acceptTime, pathState.nodeSet]);

      const edges = useMemo(() => {
        return baseEdges.map((edge) => {
          const active = pathState.edgeSet.has(edge.id);
          return {
            ...edge,
            type: 'smoothstep',
            pathOptions: { borderRadius: 16 },
            animated: false,
            style: {
              stroke: active ? '#22c55e' : '#d4d4d8',
              strokeWidth: active ? 3 : 2
            },
            markerEnd: {
              type: MarkerType.ArrowClosed,
              color: active ? '#22c55e' : '#d4d4d8'
            },
            labelBgStyle: { fill: '#ffffff', color: '#52525b', fillOpacity: 1 },
            labelBgPadding: [8, 3],
            labelBgBorderRadius: 999,
            labelStyle: { fontSize: 10, fontWeight: 500, fill: '#71717a' }
          };
        });
      }, [pathState.edgeSet]);

      return h(ReactFlowComp, {
        nodes,
        edges,
        nodeTypes,
        fitView: true,
        fitViewOptions: { padding: 0.16 },
        nodesDraggable: false,
        nodesConnectable: false,
        elementsSelectable: true,
        onNodeClick: (_, node) => setActiveNodeId(node.id)
      },
      h(Background, { gap: 18, size: 1, color: '#e5e7eb' }),
      h(Controls, { showInteractive: false }));
    }

    const root = window.ReactDOM.createRoot(document.getElementById('reactWorkflowRoot'));
    root.render(h(WorkflowApp));
  })();
</script>

<script src="main.js"></script>
<script>loadAssistantPage();</script>
</body>
</html>
