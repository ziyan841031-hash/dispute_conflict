<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>矛盾纠纷系统管理 - 智能助手</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/reactflow/dist/style.css">
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h1>矛盾纠纷系统管理</h1>
    <a href="index.html">控台首页</a>
    <a href="cases.html">案件管理</a>
    <a class="active" href="assistant.html">智能助手</a>
  </aside>
  <main class="content">
    <section class="card assistant-header-card">
      <h2>智能助手</h2>
      <div id="assistantTopInfo" class="assistant-top-grid"></div>
    </section>

    <section class="assistant-main-grid">
      <div class="card flow-card">
        <h3>智能工作流</h3>
        <div class="flow-container">
          <div id="reactWorkflowRoot" class="workflow-canvas"></div>
        </div>
      </div>

      <div class="card side-card">
        <div class="bookmark-tabs">
          <button class="bookmark-tab active" data-tab="guide" onclick="switchAssistantTab('guide')">智能指引</button>
          <button class="bookmark-tab" data-tab="timeline" onclick="switchAssistantTab('timeline')">办理时间轴</button>
        </div>

        <div class="guide-panel" data-panel="guide">
          <h3>智能指引</h3>
          <div id="guideList" class="scroll-box"></div>
          <div class="guide-input-row">
            <input id="guideInput" placeholder="输入补充指引信息..." />
            <button onclick="addGuideNote()">添加</button>
          </div>
        </div>

        <div class="timeline-panel hidden" data-panel="timeline">
          <h3>办理时间轴</h3>
          <div id="timelineList" class="timeline-vertical"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/reactflow/dist/umd/index.js"></script>
<script>
  (function () {
    if (!window.React || !window.ReactDOM || !window.ReactFlow) {
      return;
    }

    const h = window.React.createElement;
    const useMemo = window.React.useMemo;
    const useState = window.React.useState;

    const RF = window.ReactFlow;
    const ReactFlowComp = RF.ReactFlow;
    const Background = RF.Background;
    const Controls = RF.Controls;
    const MarkerType = RF.MarkerType;

    const initialNodes = [
      { id: 'accept', position: { x: 10, y: 210 }, data: { label: '已受理\n--' }, type: 'default' },
      { id: 'mediation', position: { x: 250, y: 60 }, data: { label: '调解' }, type: 'default' },
      { id: 'huajie', position: { x: 250, y: 160 }, data: { label: '化解' }, type: 'default' },
      { id: 'huanjie', position: { x: 250, y: 260 }, data: { label: '缓解' }, type: 'default' },
      { id: 'shujie', position: { x: 250, y: 360 }, data: { label: '疏解' }, type: 'default' },
      { id: 'people', position: { x: 520, y: 120 }, data: { label: '人民调解' }, type: 'default' },
      { id: 'admin', position: { x: 520, y: 230 }, data: { label: '行政调解' }, type: 'default' },
      { id: 'professional', position: { x: 520, y: 340 }, data: { label: '专业调解' }, type: 'default' },
      { id: 'status', position: { x: 780, y: 220 }, data: { label: '调解状态' }, type: 'default' },
      { id: 'success', position: { x: 1020, y: 150 }, data: { label: '调解成功' }, type: 'default' },
      { id: 'failed', position: { x: 1020, y: 300 }, data: { label: '调解失败' }, type: 'default' },
      { id: 'archive', position: { x: 1200, y: 225 }, data: { label: '案件归档' }, type: 'default' }
    ];

    const initialEdges = [
      { id: 'e-accept-mediation', source: 'accept', target: 'mediation' },
      { id: 'e-accept-huajie', source: 'accept', target: 'huajie' },
      { id: 'e-accept-huanjie', source: 'accept', target: 'huanjie' },
      { id: 'e-accept-shujie', source: 'accept', target: 'shujie' },
      { id: 'e-mediation-people', source: 'mediation', target: 'people' },
      { id: 'e-mediation-admin', source: 'mediation', target: 'admin' },
      { id: 'e-mediation-professional', source: 'mediation', target: 'professional' },
      { id: 'e-people-status', source: 'people', target: 'status' },
      { id: 'e-admin-status', source: 'admin', target: 'status' },
      { id: 'e-professional-status', source: 'professional', target: 'status' },
      { id: 'e-status-success', source: 'status', target: 'success' },
      { id: 'e-status-failed', source: 'status', target: 'failed' },
      { id: 'e-success-archive', source: 'success', target: 'archive' },
      { id: 'e-failed-archive', source: 'failed', target: 'archive' }
    ];

    function collectPath(targetId, parentMap, edgeSet, nodeSet) {
      nodeSet.add(targetId);
      if (targetId === 'accept') return;
      const edges = parentMap[targetId] || [];
      edges.forEach((edge) => {
        edgeSet.add(edge.id);
        collectPath(edge.source, parentMap, edgeSet, nodeSet);
      });
    }

    function WorkflowApp() {
      const [activeNode, setActiveNode] = useState('accept');
      const [acceptTime, setAcceptTime] = useState('--');

      window.updateWorkflowAcceptTime = function (timeText) {
        setAcceptTime(timeText || '--');
      };

      const parentMap = useMemo(() => {
        const map = {};
        initialEdges.forEach((edge) => {
          if (!map[edge.target]) map[edge.target] = [];
          map[edge.target].push(edge);
        });
        return map;
      }, []);

      const activeEdgeIds = useMemo(() => {
        const eSet = new Set();
        const nSet = new Set();
        collectPath(activeNode, parentMap, eSet, nSet);
        return eSet;
      }, [activeNode, parentMap]);

      const activeNodeIds = useMemo(() => {
        const eSet = new Set();
        const nSet = new Set();
        collectPath(activeNode, parentMap, eSet, nSet);
        return nSet;
      }, [activeNode, parentMap]);

      const nodes = useMemo(() => {
        return initialNodes.map((node) => {
          const isActive = activeNodeIds.has(node.id);
          const isAccept = node.id === 'accept';
          const labelText = isAccept ? `已受理\n${acceptTime}` : node.data.label;
          return {
            ...node,
            data: {
              label: h('div', { className: 'rf-node-label' },
                labelText.split('\n').map((line, i) => h('div', { key: i }, line))
              )
            },
            style: {
              borderRadius: '12px',
              border: isActive ? '2px solid #16a34a' : '1px solid #cbd5e1',
              background: isActive ? '#f0fdf4' : '#ffffff',
              color: '#0f172a',
              fontSize: '12px',
              fontWeight: 600,
              padding: '6px 10px',
              width: 104,
              textAlign: 'center',
              boxShadow: isActive ? '0 0 0 2px rgba(22,163,74,.15)' : '0 1px 6px rgba(15,23,42,.1)'
            }
          };
        });
      }, [activeNodeIds, acceptTime]);

      const edges = useMemo(() => {
        return initialEdges.map((edge) => {
          const active = activeEdgeIds.has(edge.id);
          return {
            ...edge,
            type: 'step',
            animated: false,
            style: { stroke: active ? '#16a34a' : '#94a3b8', strokeWidth: active ? 3 : 2 },
            markerEnd: {
              type: MarkerType.ArrowClosed,
              color: active ? '#16a34a' : '#94a3b8'
            }
          };
        });
      }, [activeEdgeIds]);

      return h(ReactFlowComp, {
        nodes,
        edges,
        fitView: true,
        fitViewOptions: { padding: 0.1 },
        nodesDraggable: false,
        nodesConnectable: false,
        elementsSelectable: false,
        onNodeClick: (_, node) => setActiveNode(node.id)
      },
      h(Background, { gap: 20, size: 1, color: '#e2e8f0' }),
      h(Controls, { showInteractive: false }));
    }

    const root = window.ReactDOM.createRoot(document.getElementById('reactWorkflowRoot'));
    root.render(h(WorkflowApp));
  })();
</script>

<script src="main.js"></script>
<script>loadAssistantPage();</script>
</body>
</html>
